<!doctype html>
<html>
    <head>
        <title>Chatroom</title>
		<meta charset="utf-8" />

		<link rel="stylesheet" href="../css/chatroom.css" type="text/css" media="all" />
		<script type="text/javascript" src="https://cdn.wilddog.com/sdk/js/2.5.17/wilddog.js"></script>
        <script type="text/javascript" src="../js/jquery-3.2.1.min.js"></script>
		<script type="text/javascript" src="../js/jquery.s2t.js"></script>
		<script type="text/javascript" src="../js/jquery.xcolor.min.js"></script>
		
		<script type="text/javascript" src="../js/help.js"></script>
		<script type="text/javascript" src="../js/crypto-js/crypto-js.js"></script>
		

		
        <script>
            var infomsg = "本站仍在搭建中，功能实现进度：\nX 登陆注册\nX 聊天\nX 文字颜色\nX 发送图片\nX 云端同步删除\nO help()\nO 登陆密码\nO 用户自定义配置";
            var text = "text";
			var url = "url";
			var img = "img";
			var username = null;
			
			function clearMsg(password) {
				var password_sha = CryptoJS.SHA256(password).toString();
				if (password_sha=="0eb88d81684fbb613d3963d014182595e1edd5ec0070bb3c69d13ee3ce407ff7"){
					chat.remove();
					console.log("clear");
				} else {
					console.warn("password error");
				}
			}
			
			function focusTheMessage(id){
				var X = $("#"+id).position().top;
				document.body.scrollTop = X;
				return X;
			}
			
			function getTime() {
				var t = new Date();
				var time_h = t.getHours();
				var time_m = t.getMinutes();
				var time_s = t.getSeconds();
				(time_h.toString().length == 1) ? time_hh = "0" + time_h.toString() : time_hh = time_h.toString();/*如果不足2位，补0*/
				(time_m.toString().length == 1) ? time_mm = "0" + time_m.toString() : time_mm = time_m.toString();
				(time_s.toString().length == 1) ? time_ss = "0" + time_s.toString() : time_ss = time_s.toString();
				var time = time_hh + ":" + time_mm + ":" + time_ss;
				return time;
			}
			
			function tip(text,color) {
				var tipBox = document.getElementById("tipBox");
				var tipit=$("#tipBox");
				tipBox.innerHTML =text ;
				$("#tipBox").css({
					backgroundColor:color,
					fontSize:"30px",
					top:$(window).scrollTop()+10,
					textAlign:"center",
					opacity:"0",
					width:"100%",
					position:"absolute",
					zIndex:"999999",
					color:"black",
				});
				tipit.animate({
					opacity:"0.8",
				},400);
				tipit.animate({
					opacity:"0.8",
				},1000);
				tipit.animate({
					opacity:"0",
					display:"none",
					zIndex:"-1",
				},700);
			}
			
			function FloatImg(imgurl){
				var IFW = $(".FloatWindow");//IFWindow = Img Float Window
				var FI = $(".floatimg");//FI = Float Img
				var aa = $(window).scrollTop()+50;
				IFW.empty();
				$("body").append("<img src='"+imgurl+"' onclick='CloseFloatImg();' style='top:"+aa+"px' class='floatimg'/>");
				IFW.css({
					display:"inline",
					position:"absolute",
					zIndex:"9",
					height:"0%",
					width:"100%",
					backgroundColor:"rgba(0,0,0,0.6)",
					top:"0",
					bottom:"0",
					right: "0",
					left : "0",
					height:document.body.scrollHeight,
				});
				
				FI.css({
					display:"inline",
					position:"absolute",
					zIndex:"999",
					left:"50%",
					top:$(window).scrollTop()+50,
					transform:"translate(50%)",
					height:"0%",
					width:"100%",
					opacity:"0",
				});
				FI.animate({
					display:"inline",
					opacity:"1",
					height:"100%",
				},700);
			}
			
			function CloseFloatImg(){
				var IFW = $(".FloatWindow");//IFWindow = Img Float Window
				var FI = $(".floatimg");
				IFW.css({
					zIndex:"-2",
					display:"none",
				});
				FI.animate({
					opacity:"0",
					position:"absolute",
					left:"50%",
					top:"0%",
					transform:"translate(-50%,-0%)",
					height:"0%",
				},700);
				FI.css({
					zIndex:"-2",
					display:"none",
				});
				$("*").remove(".floatimg");
				IFW.empty();
				IFW.removeAttr("style");
			}
			
			
			var config = {
				authDomain: "https://wd6413466545jrbfqv.wilddog.com",
				syncURL: "https://wd6413466545jrbfqv.wilddogio.com"};
			wilddog.initializeApp(config);
			var chat = wilddog.sync().ref("/chat");
			
			function reg(username) {
				var userRoot = wilddog.sync().ref();
				userRoot.once("value")
					.then(function(snapshot) {
						var name = snapshot.child("/users/"+username).exists();
						if (name == false) {
							userRoot.child("users/"+username).set({"name":username,"regTime":new Date().toString(),"LastLogin":getTime()})
						} else {
							console.error("'" +username+"'已经存在")
						}
					}
				);
			}
			
			function login(username) {
				var userRoot = wilddog.sync().ref();
				userRoot.once("value")
					.then(function(snapshot) {
						var name = snapshot.child("/users/"+username).exists();
						if (name == false) {
							console.error("'" +username+"'未注册，请用reg('"+username+"')来注册")
							tip("未注册","red");
						} else {
							window.username = username;
							console.log(""+username+":现在是"+getTime()+",祝你玩得开心");
							console.info(infomsg);
							userRoot.child("users/"+username).update({"LastLogin":getTime()});
						}
					}
				);
				tip(""+username+":现在是"+getTime()+",祝你玩得开心","#00ff40");
				return console.log("登录成功");
			}
			
			function msg(message,type,color,introtext) {
				
				switch (type) {
					case url:
						var msgtype = url;
						break;
					case text:
						var msgtype = text;
						break;
					case img:
						var msgtype = img;
						break;
					default:
						var msgtype = text;
						break;
				}
				
				if (username == null) {
					console.error("未登录，请用login('用户名')来登录");
					tip("未登录","red");
					return console.warn("消息未发送");
				} else if (message == ""){
					console.error("消息不能为空");
					return console.warn("消息未发送");
				} else if(message.length > 250){
					console.error("消息不能超过250字");
					return console.warn("消息未发送");
				} else if (color == "") {
					var color = "#bdae9d";	
				} else if (introtext == "") {
					var introtext = message;
				} else { 
					var message_t = $.s2t(message);
					var introtext_t = $.s2t(introtext);
					chat.push({"message":message_t,"type":msgtype,"introtext":introtext_t,"sendBy":username,"sendTime":getTime(),"color":color});
					return console.info("消息已发送");
				}
			}
			
			function loaded() {
				var chatBox = $(".chatmsg");
				if (getTime() == "00:00:00"){
					chat.remove();
				}
			}
			
			
			
			
			function run() {
				chat.on("child_added",function(snapshot) {
					var chatBox = $(".chatmsg");
					var text = snapshot.val().message;
					var user = snapshot.val().sendBy;
					var sendTime = snapshot.val().sendTime;
					var type = snapshot.val().type;
					var color = snapshot.val().color;
					var introtext = snapshot.val().introtext;
					var key_text = snapshot.key();
					var sendTime_html = "<span style='color:grey' class='time'>"+sendTime+"&nbsp;&nbsp;</span>";
					var user_html = "<span style='color:white;'>"+user+"</span><b style='color:grey;'>>_&nbsp;</b>";
					var img_src = "https://res.cloudinary.com/duquoda8z/image/fetch/c_scale,q_auto:eco,r_10,w_200/"+text;
					
					var innerText = "<div class='msg' id='"+key_text+"'>"+sendTime_html+user_html+"<div class='msgtext' style='color:"+color+"'>"+text+"</div></div>";
					var innerImg = "<div class='msg' id='"+key_text+"'>"+sendTime_html+user_html+"<div class='msgtext'><b style='color:white;'>"+introtext+"</b><img src='"+img_src+"'' onclick='FloatImg(\""+text+"\");' class='msg'/><small><em>点击图片看原图</em></small></div></div>";
					var innerLink = "<div class='msg' id='"+key_text+"'>"+sendTime_html+user_html+"<div class='msgtext'><a href='"+text+"' style='color:"+color+"'>"+introtext+"</a></div></div>";
					console.log("type:"+type+" '"+text+"' "+"sendBy '"+user+"' "+"at '"+sendTime+"'"+color+" "+introtext+" "+key_text);
					
					switch (type) {
						case url:
							var msgtype = url;
							chatBox.append(innerLink+"<hr class='msg' id='"+key_text+"'/>");
							break;
						case text:
							var msgtype = text;
							chatBox.append(innerText+"<hr class='msg' id='"+key_text+"'/>");
							break;
						case img:
							var msgtype = img;
							chatBox.append(innerImg+"<hr class='msg' id='"+key_text+"'/>");
							break;
						default:
							var msgtype = text;
							chatBox.append(innerText+"<hr class='msg' id='"+key_text+"'/>");
							break;
					}
				});
				chat.on("child_removed",function(snapshot_del){
					var key_text = snapshot_del.key();
					$("*").remove("#"+key_text);
				});
			}
        </script>
		<style>
			body {
				color: #bdae9d;
				//font-family: 'Inconsolata', 'GenWanMin-TW', 'GenWanMin-JP';
			}
			.msg {
				margin-top: 10px;
				margin-bottom: 0%;
				display: -moz-flex;
				display: -webkit-flex;
				display: flex;
				-moz-flex-warp: warp;
				-webkit-flex-warp: warp;
				flex-warp: warp;
				
			}
			.msgtext {
				font-size: 23px;
				text-align:justify;
				width:75%;
			}
			.time{
				font-size: 12px;
			}
			hr.msg {
				align: left;
				margin-left: 0;
				border: 0;
				height: 1px;
				background-image: linear-gradient(to right ,rgba(255, 255, 255, 0.8) ,rgba(255, 255, 255, 0.55) ,rgba(255, 255, 255, 0));
				width= 60%;
				color= #987cb9; 
				SIZE= 3;
			}
			.floatimg {
				display:inline;
				position:absolute;
				z-index:999;
				transform:translate(50%);
				opacity:1;
			}

		</style>
    </head>
	<body onload="loaded()">
	<div id="tipBox"></div>
	<h1 class="title">ChatRoom</h1>
	<em style="margin-left:50%;top:0%">--by&nbsp;Gerard</em>
	<hr />
	<br />
	<div class="chatmsg"></div>
	<div class="FloatWindow" onclick="CloseFloatImg()"></div>
	<script>
		$(document).ready(function (){run();});
	</script>
	</body>
</html>
