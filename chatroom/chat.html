<!doctype html>
<html>
    <head>
        <title>Chatroom</title>
		<meta charset="utf-8" />
		<script type="text/javascript" src="https://cdn.wilddog.com/sdk/js/2.5.17/wilddog.js"></script>
        <script type="text/javascript" src="../js/jquery-3.2.1.min.js"></script>
		<script type="text/javascript" src="../js/help.js"></script>
		<script type="text/javascript" src="../js/crypto-js/crypto-js.js"></script>
        <script>
            var infomsg = "本站仍在搭建中，功能实现进度：\nX 登陆注册\nO help()\nX 聊天\nO 登陆密码\nX 发送图片";
            var text = "text";
			var url = "url";
			var img = "img";
			var username;
			
			function clearMsg(password) {
				var password_sha = CryptoJS.SHA256(password).toString();
				if (password_sha=="0eb88d81684fbb613d3963d014182595e1edd5ec0070bb3c69d13ee3ce407ff7"){
					chat.remove();
					console.log("clear");
				} else {
					console.warn("password error");
				}
			}
			
			function getTime() {
				var t = new Date();
				var time_h = t.getHours();
				var time_m = t.getMinutes();
				var time_s = t.getSeconds();
				(time_h.toString().length == 1) ? time_hh = "0" + time_h.toString() : time_hh = time_h.toString();/*如果不足2位，补0*/
				(time_m.toString().length == 1) ? time_mm = "0" + time_m.toString() : time_mm = time_m.toString();
				(time_s.toString().length == 1) ? time_ss = "0" + time_s.toString() : time_ss = time_s.toString();
				var time = time_hh + ":" + time_mm + ":" + time_ss;
				return time;
			}
			function tip(text,color) {
				var tipBox = document.getElementById("tipBox");
				var tipit=$("#tipBox");
				tipBox.innerHTML =text ;
				$("#tipBox").css({
					backgroundColor:color,
					fontSize:"30px",
					top:"80%",
					textAlign:"center",
					opacity:"0",
					width:"100%",
					position:"absolute",
					zIndex:"999999",
				});
				tipit.animate({
					opacity:"0.8",
				},700);
				tipit.animate({
					opacity:"0.8",
				},2000);
				tipit.animate({
					opacity:"0.8",
				},2000);
				tipit.animate({
					opacity:"0",
					display:"none",
					zIndex:"-1",
				},700);
			}
			
			var config = {
				authDomain: "https://wd6413466545jrbfqv.wilddog.com",
				syncURL: "https://wd6413466545jrbfqv.wilddogio.com"};
			wilddog.initializeApp(config);
			var chat = wilddog.sync().ref("/chat");
			
			function reg(username) {
				var userRoot = wilddog.sync().ref();
				userRoot.once("value")
					.then(function(snapshot) {
						var name = snapshot.child("/users/"+username).exists();
						if (name == false) {
							userRoot.child("users/"+username).set({"name":username,"regTime":new Date().toString(),"LastLogin":getTime()})
						} else {
							console.error("'" +username+"'已经存在")
						}
					}
				);
			}
			
			function login(username) {
				var userRoot = wilddog.sync().ref();
				userRoot.once("value")
					.then(function(snapshot) {
						var name = snapshot.child("/users/"+username).exists();
						if (name == false) {
							console.error("'" +username+"'未注册，请用reg('"+username+"')来注册")
							tip("未注册","red");
						} else {
							window.username = username;
							console.log(""+username+":现在是"+getTime()+",祝你玩得开心");
							console.info(infomsg);
							userRoot.child("users/"+username).update({"LastLogin":getTime()});
							tip(""+username+":现在是"+getTime()+",祝你玩得开心","#00ff40");
						}
					}
				);
			}
			
			function msg(message,type) {
				switch (type) {
					case url:
						var msgtype = url;
						break;
					case text:
						var msgtype = text;
						break;
					case img:
						var msgtype = img;
						break;
					default:
						var msgtype = text;
						break;
				}
				if (username == null) {
					console.error("未登录，请用login('用户名')来登录");
					tip("未登录","red");
					return console.warn("消息未发送");
				} else {
					chat.push({"message":message,"type":msgtype,"sendBy":username,"sendTime":getTime()});
					return console.info("消息已发送");
				}
			}	
			
			function loaded() {
				var chatBox = $(".chatmsg");
				if (getTime() == "00:00:00"){
					chat.remove();
				}
			}
			
			
			function run() {
				chat.on("child_added",function(snapshot) {
					var chatBox = $(".chatmsg");
					var text = snapshot.val().message;
					var user = snapshot.val().sendBy;
					var sendTime = snapshot.val().sendTime;
					var type = snapshot.val().type;
					var sendTime_html = "<span style='color:grey' class='time'>"+sendTime+"&nbsp;&nbsp;</span>";
					var user_html = "<span style='color:white;'>"+user+"</span><b style='color:grey;'>>_&nbsp;</b>";
					var innerText = "<div class='msg'>"+sendTime_html+user_html+"<span class='msg'>"+text+"</span></div>";
					var img_src = "https://res.cloudinary.com/duquoda8z/image/fetch/c_scale,q_auto:eco,r_10,w_400/"+text;
					var innerImg = "<div class='msg'>"+sendTime_html+user_html+"<span class='msg'><a href='"+text+"'><img src='"+img_src+"'/></a></span><small><em>点击图片看原图</em></small></div>";
					var innerLink = "<div class='msg'>"+sendTime_html+user_html+"<span class='msg'><a href='"+text+"'>"+text+"</a></span></div>";
					console.log("type:"+type+" '"+text+"' "+"sendBy '"+user+"' "+"at '"+sendTime+"'");
					switch (type) {
					case url:
						var msgtype = url;
						chatBox.append(innerLink);
						break;
					case text:
						var msgtype = text;
						chatBox.append(innerText);
						break;
					case img:
						var msgtype = img;
						chatBox.append(innerImg);
						break;
					default:
						var msgtype = text;
						chatBox.append(innerText);
						break;
					}
					
				});
			}
        </script>
		<style>
			@import url(../css/chatroom.css);
			body {
				color: #bdae9d;
			}
			div.msg {
				margin-top: 0%;
				margin-bottom: 0%;
			}
			span.msg {
				font-size: 20px;
				
			}
			.time{
				font-size: 10px;
			}
		</style>
    </head>
	<body onload="loaded()">
	<div id="tipBox"></div>
	<h1 class="title">预留</h1>
	<hr />
	<br />
	<div class="chatmsg"></div>
	<script>
		$(document).ready(function (){run();});
	</script>
	</body>
</html>
